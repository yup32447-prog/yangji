<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å…»åŸºå® - AIè¯†åˆ«ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .up { color: #f87171; } .down { color: #4ade80; }
        .blur-val { filter: blur(5px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-24">

<div id="app" class="max-w-md mx-auto">
    <div class="bg-blue-600 p-6 rounded-b-[2rem] shadow-lg text-white">
        <div class="flex justify-between items-center mb-4">
            <span class="text-sm opacity-80" id="date-label">è½½å…¥ä¸­...</span>
            <div class="flex gap-3">
                <button onclick="togglePrivacy()" class="text-xl">ğŸ‘ï¸</button>
                <button onclick="location.reload()" class="text-xl">ğŸ”„</button>
            </div>
        </div>
        <p class="text-xs opacity-70">é¢„ä¼°æ€»ç›ˆäº (å…ƒ)</p>
        <h2 id="total-profit" class="text-4xl font-black my-1">0.00</h2>
        <div class="flex justify-between mt-4 text-xs bg-white/10 p-2 rounded-lg">
            <span>æ€»èµ„äº§: <b id="total-assets" class="money-val">Â¥0.00</b></span>
            <span id="update-status">æ­£åœ¨è·å–è¡Œæƒ…...</span>
        </div>
    </div>

    <div class="flex gap-2 p-4 -mt-4">
        <label class="flex-1 bg-white p-3 rounded-xl shadow-sm text-center cursor-pointer border-2 border-dashed border-blue-200">
            <span class="text-sm font-bold text-blue-600">ğŸ“¸ è¯†åˆ«æˆªå›¾æ·»åŠ </span>
            <input type="file" accept="image/*" onchange="handleOCR(this)" class="hidden">
        </label>
        <button onclick="showManualAdd()" class="bg-white px-6 rounded-xl shadow-sm text-sm font-bold text-gray-600">æ‰‹åŠ¨</button>
    </div>

    <div id="ocr-loading" class="hidden mx-4 mb-4 p-3 bg-blue-50 text-blue-600 text-xs rounded-lg text-center">
        æ­£åœ¨è§£æå›¾ç‰‡ä¸­çš„åŸºé‡‘æ•°æ®ï¼Œè¯·ç¨å...
    </div>

    <div id="fund-list" class="px-4 space-y-3">
        </div>
</div>

<div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-6 z-50">
    <div class="bg-white w-full rounded-2xl p-6">
        <h3 class="font-bold mb-4">æ·»åŠ /ä¿®æ”¹æŒä»“</h3>
        <input type="text" id="fCode" placeholder="6ä½åŸºé‡‘ä»£ç " class="w-full border p-3 rounded-lg mb-3">
        <input type="number" id="fAmount" placeholder="æŒæœ‰é‡‘é¢" class="w-full border p-3 rounded-lg mb-4">
        <div class="flex gap-2">
            <button onclick="closeModal()" class="flex-1 py-3 text-gray-500">å–æ¶ˆ</button>
            <button onclick="saveManual()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    let myPortfolio = JSON.parse(localStorage.getItem('myPortfolio_v3')) || [];
    let isPrivacy = false;

    // --- OCR è¯†åˆ«é€»è¾‘ ---
    async function handleOCR(input) {
        if (!input.files[0]) return;
        const loader = document.getElementById('ocr-loading');
        loader.classList.remove('hidden');
        
        try {
            const result = await Tesseract.recognize(input.files[0], 'chi_sim+eng');
            const text = result.data.text;
            console.log("è¯†åˆ«ç»“æœ:", text);
            
            // åŒ¹é…é€»è¾‘ï¼šæ‰¾ 6 ä½æ•°å­—ä»£ç  æˆ– å¸¸è§çš„åŸºé‡‘åç§°å…³é”®å­—
            // é’ˆå¯¹ä½ çš„å›¾ç‰‡ï¼Œå°è¯•åŒ¹é…â€œä¹°å…¥â€åçš„é‡‘é¢
            const amountMatches = text.match(/\d+\.\d{2}/g); // åŒ¹é…é‡‘é¢å¦‚ 500.00
            
            // è¿™é‡Œå› ä¸ºå¤©å¤©åŸºé‡‘æ¥å£éœ€è¦ä»£ç ï¼Œå»ºè®®è¯†åˆ«åå¼¹çª—è®©ç”¨æˆ·ç¡®è®¤
            alert("è¯†åˆ«å®Œæˆï¼æ£€æµ‹åˆ°å¯èƒ½é‡‘é¢: " + (amountMatches ? amountMatches[0] : "æœªè¯†åˆ«åˆ°"));
            // å®é™…åº”ç”¨ä¸­ï¼Œç”±äºOCRè¯†åˆ«ä¸­æ–‡åŸºé‡‘åè½¬ä»£ç éœ€è¦æ•°æ®åº“ï¼Œ
            // å»ºè®®è¿™é‡Œè·³è½¬åˆ°æ‰‹åŠ¨è¾“å…¥ï¼Œå¹¶è‡ªåŠ¨å¡«å…¥è¯†åˆ«åˆ°çš„é‡‘é¢
            showManualAdd('', amountMatches ? amountMatches[0] : '');
        } catch (e) {
            alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥");
        } finally {
            loader.classList.add('hidden');
        }
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---
    window.jsonpgz = function(data) {
        const item = myPortfolio.find(f => f.code === data.fundcode);
        if (!item) return;

        const ratio = parseFloat(data.gszzl);
        item.lastProfit = item.amount * (ratio / 100);
        item.currentTotal = item.amount + item.lastProfit;
        item.name = data.name;

        renderList();
        updateHeader();
    };

    function renderList() {
        const listBody = document.getElementById('fund-list');
        listBody.innerHTML = myPortfolio.map(item => `
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-50">
                <div onclick="showManualAdd('${item.code}', '${item.amount}')" class="flex-1">
                    <h4 class="font-bold text-gray-800 text-sm truncate w-40">${item.name || 'åŠ è½½ä¸­...'}</h4>
                    <p class="text-[10px] text-gray-400">æœ¬é‡‘: Â¥<span class="money-val">${item.amount.toLocaleString()}</span></p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-black ${item.lastProfit >= 0 ? 'up' : 'down'}">
                        <span class="money-val">${item.lastProfit >= 0 ? '+' : ''}${item.lastProfit.toFixed(2)}</span>
                    </p>
                    <button onclick="removeFund('${item.code}')" class="text-[10px] text-gray-300">åˆ é™¤æŒä»“</button>
                </div>
            </div>
        `).join('');
        if(isPrivacy) applyPrivacyUI();
    }

    function updateHeader() {
        const totalProfit = myPortfolio.reduce((s, f) => s + (f.lastProfit || 0), 0);
        const totalAssets = myPortfolio.reduce((s, f) => s + (f.currentTotal || f.amount), 0);
        
        const profitEl = document.getElementById('total-profit');
        profitEl.innerText = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
        profitEl.className = `text-4xl font-black my-1 ${totalProfit >= 0 ? 'text-white' : 'text-green-300'}`;
        
        document.getElementById('total-assets').innerText = `Â¥${totalAssets.toLocaleString(undefined, {minimumFractionDigits:2})}`;
        document.getElementById('date-label').innerText = new Date().toLocaleDateString() + " å®æ—¶ä¼°å€¼";
        document.getElementById('update-status').innerText = "å·²æ›´æ–° " + new Date().toLocaleTimeString();
    }

    // --- äº¤äº’åŠŸèƒ½ ---
    function showManualAdd(code = '', amount = '') {
        document.getElementById('fCode').value = code;
        document.getElementById('fAmount').value = amount;
        document.getElementById('modal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    function saveManual() {
        const code = document.getElementById('fCode').value;
        const amount = parseFloat(document.getElementById('fAmount').value);
        if(code && amount) {
            const index = myPortfolio.findIndex(f => f.code === code);
            if(index > -1) myPortfolio[index].amount = amount;
            else myPortfolio.push({code, amount, lastProfit:0});
            
            localStorage.setItem('myPortfolio_v3', JSON.stringify(myPortfolio));
            closeModal();
            refreshData();
        }
    }

    function removeFund(code) {
        myPortfolio = myPortfolio.filter(f => f.code !== code);
        localStorage.setItem('myPortfolio_v3', JSON.stringify(myPortfolio));
        renderList();
        updateHeader();
    }

    function togglePrivacy() {
        isPrivacy = !isPrivacy;
        applyPrivacyUI();
    }

    function applyPrivacyUI() {
        const elements = document.querySelectorAll('.money-val');
        elements.forEach(el => isPrivacy ? el.classList.add('blur-val') : el.classList.remove('blur-val'));
        const totalProfit = document.getElementById('total-profit');
        isPrivacy ? totalProfit.classList.add('blur-val') : totalProfit.classList.remove('blur-val');
    }

    function refreshData() {
        myPortfolio.forEach(item => {
            const s = document.createElement('script');
            s.src = `https://fundgz.1234567.com.cn/js/${item.code}.js?rt=${Date.now()}`;
            document.body.appendChild(s);
        });
    }

    // æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
    setInterval(refreshData, 60000);
    window.onload = refreshData;
</script>
</body>
</html>
